---
title: "IDS Group Project"
subtitle: "Formula E Race Result"
author: "Table 5 Tekkers <br> Joel Barron, Jamie Burrell, Farhan Khan, Yara Kanaan,Muhammad Aiman, Hylda Azizi"
institute: "University of Edinburgh"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      
---

```{r install-package, include = FALSE, eval = FALSE}
# Copy and paste the following code into your console to download and install
# the `xaringan` package that contains all of the code which allows you 
# to create presentation slides in Rmarkdown
install.packages('xaringan')
```


```{r load-packages, include = FALSE}
# Add any additional packages you need to this chunk
library(tidyverse)
library(tidymodels)
library(palmerpenguins)
library(knitr)
library(xaringanthemer)
library(ggplot2)
library(gghighlight)
```

```{r setup, include=FALSE}
# For better figure resolution
knitr::opts_chunk$set(fig.retina = 3, dpi = 300, fig.width = 6, fig.asp = 0.618, out.width = "80%")
```

```{r load-data, include=FALSE}
# Load your data here
formula_e_race_results <- read.csv("data/formula_e_race_results.csv")
```


```{r cleaning data, include=FALSE}
formula_e_race_results <- formula_e_race_results %>%
  mutate(
    location = case_when(
      str_detect(race_name, "Beijing") ~ "Beijing",
      str_detect(race_name, "Punta del Este") ~ "Punta del Este",
      str_detect(race_name, "Putrajaya") ~ "Putrajaya",
      str_detect(race_name, "Berlin") ~ "Berlin",
      str_detect(race_name, "Buenos Aires") ~ "Buenos Aires",
      str_detect(race_name, "London") ~ "London",
      str_detect(race_name, "Long Beach") ~ "Long Beach",
      str_detect(race_name, "Miami") ~ "Miami",
      str_detect(race_name, "Monaco") ~ "Monaco",
      str_detect(race_name, "Moscow") ~ "Moscow",
      str_detect(race_name, "Hong Kong") ~ "Hong Kong",
      str_detect(race_name, "Marrakesh") ~ "Marrakesh",
      str_detect(race_name, "Mexico City") ~ "Mexico City",
      str_detect(race_name, "Paris") ~ "Paris",
      str_detect(race_name, "Montreal") ~ "Montreal",
      str_detect(race_name, "New York City") ~ "New York City",
      str_detect(race_name, "Diriyah") ~ "Diriyah",
      str_detect(race_name, "Rome") ~ "Rome",
      str_detect(race_name, "Santiago") ~ "Santiago",
      str_detect(race_name, "Sanya") ~ "Sanya",
      str_detect(race_name, "Swiss") ~ "Bern",
      TRUE ~ "Zurich"
    )
  )

formula_e_race_results <- formula_e_race_results %>%
  mutate(
    finished = case_when(
      str_detect(time_retired, "W") ~ FALSE,
      str_detect(time_retired, "U") ~ FALSE,
      str_detect(time_retired, "T") ~ FALSE,
      str_detect(time_retired, "A") ~ FALSE,
      str_detect(time_retired, "S") ~ FALSE,
      str_detect(time_retired, "R") ~ FALSE,
      str_detect(time_retired, "w") ~ FALSE,
      str_detect(time_retired, "P") ~ FALSE,
      str_detect(time_retired, "M") ~ FALSE,
      str_detect(time_retired, "O") ~ FALSE,
      str_detect(time_retired, "H") ~ FALSE,
      str_detect(time_retired, "G") ~ FALSE,
      str_detect(time_retired, "F") ~ FALSE,
      str_detect(time_retired, "E") ~ FALSE,
      str_detect(time_retired, "D") ~ FALSE,
      str_detect(time_retired, "C") ~ FALSE,
      str_detect(time_retired, "B") ~ FALSE,
      TRUE ~ TRUE
    )
  )

raceresults_cleaned <- formula_e_race_results %>%
  select(
    driver, team_group, location, rank_num, finished
  )

raceresults_factored <- raceresults_cleaned %>%
  mutate(
    finished_fct = case_when(
      finished == TRUE ~ "TRUE",
      finished == FALSE ~ "FALSE"
    ),
  finished_fct = fct_relevel(finished_fct, "TRUE", "FALSE"))


raceresults_factored <- raceresults_factored %>%
  group_by(driver) %>%
  filter(n() >= 20) %>%
  ungroup()

raceresults_factored <- raceresults_factored %>%
  group_by(location) %>%
  filter(n() > 24) %>%
  ungroup()


```

```{r include=FALSE}

#Background image
style_xaringan(
  title_slide_background_image = "img/intro picture.jpg",
  title_slide_text_color = "white",
  background_color = "#191970", "white", "#87CEEB",
  text_font_google = google_font("Work Sans", "300", "300i"),
  code_font_google = google_font("IBM Plex Mono"), 
  text_font_size = "1.2rem"
)

```
class: center, middle

- <font size="10">How is driver performance affected by their team, the track, their age and any other factors?</font>

---
# Question setting and process

- insert text
--

- insert text


---

# Dataset 

- Our data set has 19 variables and 1480 observations
``` {r glimpse dataset, echo = FALSE}
glimpse(formula_e_race_results)
```
---
# Data cleaning

- Created new binary outcome variable _finished_ and converted this to a factor

--

- Created new categorical predictor variable _location_ (Challenges included inconsistencies in race names, and accents)
--

- New data set with 5 variables - 2 outcomes and 3 predictors
``` {r glimpse new dataset, echo = FALSE}
glimpse(raceresults_factored)
```

---





---

# insert subtitle (Joel)

- insert text
--

- insert text (the -- makes the text appear incrementally)

--

- insert text 

- can edit the font size like this: 
---

# Summary statistics (Yara)

- insert text..


---

# data visualisations (Joel)

- insert text
--

- insert text (add code)
we have to put echo = false  {r plot-iris, echo = FALSE}
# Code hidden with echo = FALSE
# Uses modified iris dataset from previous chunk
# Play around with height and width until you're happy with the look

delete this text after wards (the one on top)

---
# Exploring Drivers
--
```{r driver graph 1, echo=FALSE}
raceresults_cleaned %>%
  group_by(driver) %>%
  summarise(
    proportion_DNF = 1 - mean(finished),
    avg_position = mean(rank_num),
    count = n()
  ) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = avg_position
  )) +
  geom_point() +
  labs(
    x = "Observed Probability of DNF",
    y = "Average Finishing Posiiton"
  )
```
---
# Exploring Drivers
```{r driver graph 2, echo=FALSE}
raceresults_cleaned %>%
  group_by(driver) %>%
  summarise(
    proportion_DNF = 1 - mean(finished),
    avg_position = mean(rank_num),
    count = n()
  ) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = avg_position
  )) +
  geom_point() +
  labs(
    x = "Observed Probability of DNF",
    y = "Average Finishing Posiiton"
  ) +
  gghighlight(driver == "Pierre Gasly", label_key = driver)
```
---
# Exploring Drivers
```{r driver graph 3, echo=FALSE}
raceresults_cleaned %>%
  group_by(driver) %>%
  summarise(
    proportion_DNF = 1 - mean(finished),
    avg_position = mean(rank_num),
    count = n()
  ) %>% 
  filter(count >=15) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = avg_position
  )) +
  geom_point() +
  labs(
    x = "Observed Probability of DNF",
    y = "Average Finishing Posiiton"
  ) +
  geom_smooth(method = "lm", se = FALSE, colour = "grey")
```
---
# Exploring Drivers
```{r driver graph 4, echo=FALSE}
raceresults_cleaned %>%
  group_by(driver) %>%
  summarise(
    proportion_DNF = 1 - mean(finished),
    avg_position = mean(rank_num),
    count = n()
  ) %>% 
  filter(count >=15) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = avg_position
  )) +
  geom_point() +
  gghighlight(driver %in% c("Lucas di Grassi", "Sébastien Buemi", "Jean-Éric Vergne", "Sam Bird"), label_key = driver) +
  labs(
    x = "Observed Probability of DNF",
    y = "Average Finishing Posiiton"
  )
```
---
# Exploring Drivers
```{r driver graph 5, echo=FALSE}
raceresults_cleaned %>%
  group_by(driver) %>%
  summarise(
    proportion_DNF = 1 - mean(finished),
    avg_position = mean(rank_num),
    count = n()
  ) %>% 
  filter(count >=15) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = avg_position
  )) +
  geom_point() +
  gghighlight(driver %in% c("Tom Dillmann","Daniel Abt", "Stéphane Sarrazin", "Maximilian Günther"), label_key = driver) +
  labs(
    x = "Observed Probability of DNF",
    y = "Average Finishing Posiiton"
  )
```
---
# Exploring Drivers
```{r driver graph 6, echo=FALSE}
boxplot_data <- raceresults_cleaned %>%
  filter(driver %in% c("Tom Dillmann","Daniel Abt", "Stéphane Sarrazin", "Maximilian Günther")) %>%
  mutate(order = case_when(
    driver == "Tom Dillmann" ~ 3,
    driver == "Daniel Abt" ~ 2,
    driver == "Stéphane Sarrazin" ~ 1,
    driver == "Maximilian Günther" ~ 4
  ))

boxplot_data %>%
  ggplot(mapping = aes(
    x = reorder(driver, order),
    y = rank_num,
    fill = driver
  )) +
  geom_boxplot(coef = 1) +
  labs(
    y = "Final Position",
    x = "Driver"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
---
# Exploring Track Locations
--
```{r location graphs 1, echo=FALSE}
raceresults_cleaned %>%
  group_by(location) %>%
  summarise(
    proportion_DNF = 1 - mean(finished)
  ) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = location
  )) +
  geom_col() +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    y = "Track Location",
    x = "Observed Probability of DNFs"
  )
```
---
# Exploring Track Locations
```{r location graphs 2, echo=FALSE}
raceresults_cleaned %>%
  group_by(location) %>%
  summarise(
    proportion_DNF = 1 - mean(finished)
  ) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = location,
    fill = location
  )) +
  scale_fill_manual(values = c(
    "Sanya" = "#c21fd4",
    "Moscow" = "#c21fd4",
    "Zurich" = "#c21fd4",
    "Miami" = "#c21fd4",
    "Bern" = "#c21fd4"
  )) +
  geom_col() +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    y = "Track Location",
    x = "Observed Probability of DNFs"
  )
```
---
# Exploring Locations
```{r location graphs 3, echo=FALSE}
raceresults_cleaned %>% 
  group_by(location) %>%
  summarise(
    proportion_DNF = 1 - mean(finished),
    count = n()
  ) %>%
  filter(count > 24) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = location
  )) +
  geom_col() +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    y = "Track Location",
    x = "Observed Probability of DNFs"
  )

```
---
# Exploring the effect of Teams
--
```{r team graph 1, echo=FALSE}
raceresults_cleaned %>%
  group_by(team_group) %>%
  summarise(
    proportion_DNF = 1 - mean(finished),
    count = n()
  ) %>%
  filter(count >= 20) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = team_group
  )) +
  geom_col() +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    x = "Observed Probability of DNF",
    y = "Team"
  )
```
---
# Exploring the effect of Teams
```{r team graph 2, echo=FALSE}
raceresults_cleaned %>%
  group_by(team_group) %>%
  summarise(
    proportion_DNF = 1 - mean(finished),
    count = n()
  ) %>%
  filter(count >= 20) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = team_group,
    fill = team_group
  )) +
  scale_fill_manual(values = c(
    "Trulli" = "#2ab6ed"
  )) +
  geom_col() +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    x = "Observed Probability of DNF",
    y = "Team"
  )
```
---
# Model Selection 
 1)	Choosing the variable to predict and the predictors
- We choose to predict the variable finished, which indicates whether the driver finished the race or not. This is chosen as it depicts the driver’s performance throughout the race. 
- The variable that we choose to be the predictor is the driver itself,  the team group, and the location of the race being held. This is chosen based on the correlation depicted by visualisation before.


--
2)	Choosing the type of model and engine
- Logistic regression is a GLM used to model a binary categorical outcome using numerical and categorical predictors.  Since we were predicting whether they finished the race or not, this falls under binary categorical outcome. The predictors also consist of numerical and categorical predictors. The team group and the location can be considered as categorial predictors, which fits the condition of logistic regression model

 

---
# model implementation (Farhan) 

- Model Implementation (Splitting the data & creating the recipe)
--
```{r, echo=TRUE}
set.seed(28)
raceresults_split <- initial_split(raceresults_factored)
raceresults_train <- training(raceresults_split)
raceresults_test <- testing(raceresults_split)

raceresults_rec <- recipe(finished_fct ~ driver + team_group + location, data = raceresults_train) %>%
  step_dummy(all_nominal(), -all_outcomes())

```

```{r, echo=FALSE}
raceresults_mod <- logistic_reg() %>%
  set_engine("glm")
```

- Set random seed to make results reproducible
- We used the predictors team group and location to test for finishing outcome (whether they finished the race or not)

---

Model Implementation (Workflow)
--
```{r, echo=TRUE}
raceresults_wflow <- workflow() %>%
  add_recipe(raceresults_rec) %>%
  add_model(raceresults_mod)
```

-Created workflow to effectively combine steps in order to train data easily

---
Model Implementation (Training the data)
--
```{r, echo=TRUE}
raceresults_fit <- raceresults_wflow %>%
  fit(data = raceresults_train)
tidy(raceresults_fit)

raceresults_pred <- predict(raceresults_fit, raceresults_test, type = "prob") %>%
  bind_cols(raceresults_test)
raceresults_pred
```

-Used the training data to allow model to learn what the most influential predictors are
-Creates a reliable model which is now trained to make predictions based on the variables it's fed

---
# model interpretation (Aiman) (I left that code there but you can delete it)

1. We used estimation coefficient and p-values to interpret the multiple predictors (driver, team group and location)
--


2. This tools shows whether the predictors have a significant effect on the race result or not.


---

# Evaluating our model - 3 variables
``` {r model with 3, include = FALSE}
set.seed(28)
raceresults_split <- initial_split(raceresults_factored)
raceresults_train <- training(raceresults_split)
raceresults_test <- testing(raceresults_split)


raceresults_rec <- recipe(finished_fct ~ driver + team_group + location, data = raceresults_train) %>%
  step_dummy(all_nominal(), -all_outcomes())

raceresults_mod <- logistic_reg() %>%
  set_engine("glm")

raceresults_wflow <- workflow() %>%
  add_recipe(raceresults_rec) %>%
  add_model(raceresults_mod)

raceresults_fit <- raceresults_wflow %>%
  fit(data = raceresults_train)
tidy(raceresults_fit)

raceresults_pred <- predict(raceresults_fit, raceresults_test, type = "prob") %>%
  bind_cols(raceresults_test)
raceresults_pred
```

```{r roc 3, echo = FALSE}
raceresults_pred %>%
  roc_curve(
    truth = finished_fct,
    .pred_TRUE,
    event_level = "first"
  ) %>%
  autoplot()
```

---

# Evaluating our model - 1 variable
``` {r model with location, include = FALSE}
set.seed(28)
raceresults_split <- initial_split(raceresults_factored)
raceresults_train <- training(raceresults_split)
raceresults_test <- testing(raceresults_split)


raceresults_rec <- recipe(finished_fct ~ location, data = raceresults_train) %>%
  step_dummy(all_nominal(), -all_outcomes())

raceresults_mod <- logistic_reg() %>%
  set_engine("glm")

raceresults_wflow <- workflow() %>%
  add_recipe(raceresults_rec) %>%
  add_model(raceresults_mod)

raceresults_fit <- raceresults_wflow %>%
  fit(data = raceresults_train)
tidy(raceresults_fit)

raceresults_pred <- predict(raceresults_fit, raceresults_test, type = "prob") %>%
  bind_cols(raceresults_test)
raceresults_pred
```

``` {r roc location, echo = FALSE}
raceresults_pred %>%
  roc_curve(
    truth = finished_fct,
    .pred_TRUE,
    event_level = "first"
  ) %>%
  autoplot()
```

--- 

# summary/ conclusions (Hylda)

- insert text 

--

- insert text 

---

.pull-left[
- Some text
- goes here
]
.pull-right[
```{r warning=FALSE, out.width="100%", fig.width=4, echo=FALSE}
# see how I changed out.width and fig.width from defaults
# to make the figure bigger
ggplot(penguins, aes(x = bill_length_mm, y = species, color = species)) +
  geom_boxplot() +
  theme_minimal()
```
]
---
we have to put echo = false  {r plot-iris, echo = FALSE}
# Code hidden with echo = FALSE
# Uses modified iris dataset from previous chunk
# Play around with height and width until you're happy with the look

delete this text after wards (the one on top)





(extra instrctions in the bottom)

If you want to generate a table, make sure it is in the HTML format (instead of Markdown or other formats), e.g.,

```{r iris-table, echo = FALSE}
kable(head(iris), format = "html")
```

---

# Images

```{r castle, echo = FALSE, out.width = "55%", fig.align = "center", fig.cap = "Image credit: Photo by Jörg Angeli on Unsplash."}
include_graphics("img/edinburgh-castle.jpg")
```

Or you can also include a full page image. See next slide.

# Layouts

You can use plain text

- or bullet points

.pull-left[
or text in two columns $^*$
]
.pull-right[
- like
- this
]

.footnote[
[*] And add footnotes
]

---

---


class: inverse, center, middle
background-image: url(img/edinburgh-castle.jpg)
background-size: contain
---

# Math Expressions

You can write LaTeX math expressions inside a pair of dollar signs, e.g. &#36;\alpha+\beta$ renders $\alpha+\beta$. You can use the display style with double dollar signs:

```
$$\bar{X}=\frac{1}{n}\sum_{i=1}^nX_i$$
```

$$\bar{X}=\frac{1}{n}\sum_{i=1}^nX_i$$

Limitations:

1. The source code of a LaTeX math expression must be in one line, unless it is inside a pair of double dollar signs, in which case the starting `$$` must appear in the very beginning of a line, followed immediately by a non-space character, and the ending `$$` must be at the end of a line, led by a non-space character;

1. There should not be spaces after the opening `$` or before the closing `$`.

1. Math does not work on the title slide (see [#61](https://github.com/yihui/xaringan/issues/61) for a workaround).

---

# Feeling adventurous?

- Want to find out more about `xaringan`? See https://slides.yihui.name/xaringan/#1.

- You are welcome to use the default styling of the slides. In fact, that's what I expect majority of you will do. You will differentiate yourself with the content of your presentation.

- But some of you might want to play around with slide styling. The 
`xaringanthemer` provides some solutions for this that: https://pkg.garrickadenbuie.com/xaringanthemer.

- And if you want more bells and whistles, there is also `xaringanExtra`: https://pkg.garrickadenbuie.com/xaringanExtra.
