---
title: "IDS Group Project"
subtitle: "Formula E Race Result"
author: "Table 5 Tekkers <br> Joel Barron, Jamie Burrell, Farhan Khan, Yara Kanaan,Muhammad Aiman, Hylda Azizi"
institute: "University of Edinburgh"
date: "`r Sys.Date()`"
output:
  xaringan::moon_reader:
    css: xaringan-themer.css
    lib_dir: libs
    nature:
      ratio: "16:9"
      highlightStyle: github
      highlightLines: true
      countIncrementalSlides: false
      
---

```{r install-package, include = FALSE, eval = FALSE}
# Copy and paste the following code into your console to download and install
# the `xaringan` package that contains all of the code which allows you 
# to create presentation slides in Rmarkdown
install.packages('xaringan')
```


```{r load-packages, include = FALSE}
# Add any additional packages you need to this chunk
library(tidyverse)
library(tidymodels)
library(palmerpenguins)
library(knitr)
library(xaringanthemer)
library(ggplot2)
library(gghighlight)
```

```{r setup, include=FALSE}
# For better figure resolution
knitr::opts_chunk$set(fig.retina = 3, dpi = 300, fig.width = 6, fig.asp = 0.618, out.width = "80%")

options(warn = -1)
```

```{r load-data, include=FALSE}
# Load your data here
formula_e_race_results <- read.csv("data/formula_e_race_results.csv")
```


```{r cleaning data, include=FALSE}
formula_e_race_results <- formula_e_race_results %>%
  mutate(
    location = case_when(
      str_detect(race_name, "Beijing") ~ "Beijing",
      str_detect(race_name, "Punta del Este") ~ "Punta del Este",
      str_detect(race_name, "Putrajaya") ~ "Putrajaya",
      str_detect(race_name, "Berlin") ~ "Berlin",
      str_detect(race_name, "Buenos Aires") ~ "Buenos Aires",
      str_detect(race_name, "London") ~ "London",
      str_detect(race_name, "Long Beach") ~ "Long Beach",
      str_detect(race_name, "Miami") ~ "Miami",
      str_detect(race_name, "Monaco") ~ "Monaco",
      str_detect(race_name, "Moscow") ~ "Moscow",
      str_detect(race_name, "Hong Kong") ~ "Hong Kong",
      str_detect(race_name, "Marrakesh") ~ "Marrakesh",
      str_detect(race_name, "Mexico City") ~ "Mexico City",
      str_detect(race_name, "Paris") ~ "Paris",
      str_detect(race_name, "Montreal") ~ "Montreal",
      str_detect(race_name, "New York City") ~ "New York City",
      str_detect(race_name, "Diriyah") ~ "Diriyah",
      str_detect(race_name, "Rome") ~ "Rome",
      str_detect(race_name, "Santiago") ~ "Santiago",
      str_detect(race_name, "Sanya") ~ "Sanya",
      str_detect(race_name, "Swiss") ~ "Bern",
      TRUE ~ "Zurich"
    )
  )

formula_e_race_results <- formula_e_race_results %>%
  mutate(
    finished = case_when(
      str_detect(time_retired, "W") ~ FALSE,
      str_detect(time_retired, "U") ~ FALSE,
      str_detect(time_retired, "T") ~ FALSE,
      str_detect(time_retired, "A") ~ FALSE,
      str_detect(time_retired, "S") ~ FALSE,
      str_detect(time_retired, "R") ~ FALSE,
      str_detect(time_retired, "w") ~ FALSE,
      str_detect(time_retired, "P") ~ FALSE,
      str_detect(time_retired, "M") ~ FALSE,
      str_detect(time_retired, "O") ~ FALSE,
      str_detect(time_retired, "H") ~ FALSE,
      str_detect(time_retired, "G") ~ FALSE,
      str_detect(time_retired, "F") ~ FALSE,
      str_detect(time_retired, "E") ~ FALSE,
      str_detect(time_retired, "D") ~ FALSE,
      str_detect(time_retired, "C") ~ FALSE,
      str_detect(time_retired, "B") ~ FALSE,
      TRUE ~ TRUE
    )
  )

raceresults_cleaned <- formula_e_race_results %>%
  select(
    driver, team_group, location, rank_num, finished
  )

raceresults_factored <- raceresults_cleaned %>%
  mutate(
    finished_fct = case_when(
      finished == TRUE ~ "TRUE",
      finished == FALSE ~ "FALSE"
    ),
  finished_fct = fct_relevel(finished_fct, "TRUE", "FALSE"))


raceresults_factored <- raceresults_factored %>%
  group_by(driver) %>%
  filter(n() >= 20) %>%
  ungroup()

raceresults_factored <- raceresults_factored %>%
  group_by(location) %>%
  filter(n() > 24) %>%
  ungroup()


```

```{r include=FALSE}

#Background image
style_xaringan(
  title_slide_background_image = "img/intro picture.jpg",
  title_slide_text_color = "white",
  background_color = "#191970", "white", "#87CEEB",
  text_font_google = google_font("Work Sans", "300", "300i"),
  code_font_google = google_font("IBM Plex Mono"), 
  text_font_size = "1.2rem"
)

```
class: center, middle

# Question
- Based on this data set, what factors can affect driver performance within a race?

---
# Why Formula E?

- This was a topic of interest among team members

--

- The data set was formatted well with useful predictor and outcome variables

--

- The data set was large enough (sufficient observations) to make valid conclusions but not too large compared to other data sets

--
## Challenges
- Not enough quantitative data
- Many categorical variables


---
# What are we analysing?

- Evaluating the performance of Formula E drivers based on different factors, focusing on:
--

- Location ( _location_)
- Team ( _team_group_)
- Ranking ( _rank_num_)
- Number of DNFs (finishing the race or not, _finished_)

--

## This helps us identify:
- Driver consistency
- Impact of team
- Comparison between drivers
- Potential patterns or trends in driver performance

---

# Dataset 

- Our data set has 19 variables and 1480 observations
``` {r glimpse dataset, echo = FALSE}
glimpse(formula_e_race_results)
```
---
# Data cleaning

- Created new binary outcome variable _finished_ and converted this to a factor

--

- Created new categorical predictor variable _location_ (Challenges included inconsistencies in race names, and accents)
--

- New data set with 5 variables - 2 outcomes and 3 predictors
``` {r glimpse new dataset, echo = FALSE}
glimpse(raceresults_factored)
```

---

# Summary statistics

``` {r summary statistics, echo=FALSE}
 
formula_e_race_results$grid <- as.numeric(as.character(formula_e_race_results$grid))
 
summary_stats <- formula_e_race_results %>%
  group_by(driver) %>%  
  summarise(
    avg_rank = mean(rank_num, na.rm = TRUE),
    median_rank = median(rank_num, na.rm = TRUE),
    rank_sd = sd(rank_num, na.rm = TRUE),
    avg_grid = mean(grid, na.rm = TRUE),
    avg_points = mean(points, na.rm = TRUE)
  ) %>%
  
  arrange(desc(avg_points))  
 
top_10_stats <- head(summary_stats, 10)
 
print(top_10_stats)
```

---
# Summary statistics
- limited it to the top 10 drivers just to provide a brief overview of what the data looks like.
 
- To convert the data to the right format we converted grid column to a numeric using as.numeric(as.character(formula_e_race_results$grid))
 
- This was necessary in order to calculate the average grid position
--

## Some aspects to highlight:
 
- Top drivers: Sebastien Buemi and Lucas Di Grassi have the highest average points, this indicates consistent high performance. 

- Consistency: Pierre Gasly has the lowest rank standard deviation (2.12), suggesting he is the most consistent driver in terms of finishing positions.

- Median: the median rank illustrates the typical finishing position of each driver, with Pierre Gasly and Sebastien Buemi having some of the best median ranks (5 and 5.5).

---
# Exploring Drivers
--
```{r driver graph 1, echo=FALSE}
raceresults_cleaned %>%
  group_by(driver) %>%
  summarise(
    proportion_DNF = 1 - mean(finished),
    avg_position = mean(rank_num),
    count = n()
  ) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = avg_position
  )) +
  geom_point() +
  labs(
    x = "Observed Probability of DNF",
    y = "Average Finishing Posiiton"
  )
```
---
# Exploring Drivers
```{r driver graph 2, echo=FALSE}
raceresults_cleaned %>%
  group_by(driver) %>%
  summarise(
    proportion_DNF = 1 - mean(finished),
    avg_position = mean(rank_num),
    count = n()
  ) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = avg_position
  )) +
  geom_point() +
  labs(
    x = "Observed Probability of DNF",
    y = "Average Finishing Posiiton"
  ) 
  gghighlight(driver == "Pierre Gasly", label_key = driver)
```
---
# Exploring Drivers
```{r driver graph 3, echo=FALSE}
raceresults_cleaned %>%
  group_by(driver) %>%
  summarise(
    proportion_DNF = 1 - mean(finished),
    avg_position = mean(rank_num),
    count = n()
  ) %>% 
  filter(count >=15) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = avg_position
  )) +
  geom_point() +
  labs(
    x = "Observed Probability of DNF",
    y = "Average Finishing Posiiton"
  ) +
  ylim(10, 14) +
  geom_smooth(method = "lm", se = FALSE, colour = "grey")
```
---
# Exploring Drivers
```{r driver graph 4, echo=FALSE}
raceresults_cleaned %>%
  group_by(driver) %>%
  summarise(
    proportion_DNF = 1 - mean(finished),
    avg_position = mean(rank_num),
    count = n()
  ) %>% 
  filter(count >=15) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = avg_position
  )) +
  geom_point() +
  gghighlight(driver %in% c("Lucas di Grassi", "Sébastien Buemi", "Jean-Éric Vergne", "Sam Bird"), label_key = driver) +
  labs(
    x = "Observed Probability of DNF",
    y = "Average Finishing Posiiton"
  ) 
```
---
# Exploring Drivers
```{r driver graph 5, echo=FALSE}
raceresults_cleaned %>%
  group_by(driver) %>%
  summarise(
    proportion_DNF = 1 - mean(finished),
    avg_position = mean(rank_num),
    count = n()
  ) %>% 
  filter(count >=15) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = avg_position
  )) +
  geom_point() +
  gghighlight(driver %in% c("Tom Dillmann","Daniel Abt", "Stéphane Sarrazin", "Maximilian Günther"), label_key = driver) +
  labs(
    x = "Observed Probability of DNF",
    y = "Average Finishing Posiiton"
  ) 
```
---
# Exploring Drivers
```{r driver graph 6, echo=FALSE}
boxplot_data <- raceresults_cleaned %>%
  filter(driver %in% c("Tom Dillmann","Daniel Abt", "Stéphane Sarrazin", "Maximilian Günther")) %>%
  mutate(order = case_when(
    driver == "Tom Dillmann" ~ 3,
    driver == "Daniel Abt" ~ 2,
    driver == "Stéphane Sarrazin" ~ 1,
    driver == "Maximilian Günther" ~ 4
  ))

boxplot_data %>%
  ggplot(mapping = aes(
    x = reorder(driver, order),
    y = rank_num,
    fill = driver
  )) +
  geom_boxplot(coef = 1) +
  labs(
    y = "Final Position",
    x = "Driver"
  ) +
  theme_minimal() +
  theme(legend.position = "none")
```
---
# Exploring Track Locations
--
```{r location graphs 1, echo=FALSE}
raceresults_cleaned %>%
  group_by(location) %>%
  summarise(
    proportion_DNF = 1 - mean(finished)
  ) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = location
  )) +
  geom_col() +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    y = "Track Location",
    x = "Observed Probability of DNFs"
  )
```
---
# Exploring Track Locations
```{r location graphs 2, echo=FALSE}
raceresults_cleaned %>%
  group_by(location) %>%
  summarise(
    proportion_DNF = 1 - mean(finished)
  ) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = location,
    fill = location
  )) +
  scale_fill_manual(values = c(
    "Sanya" = "#c21fd4",
    "Moscow" = "#c21fd4",
    "Zurich" = "#c21fd4",
    "Miami" = "#c21fd4",
    "Bern" = "#c21fd4"
  )) +
  geom_col() +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    y = "Track Location",
    x = "Observed Probability of DNFs"
  )
```
---
# Exploring Locations
```{r location graphs 3, echo=FALSE}
raceresults_cleaned %>% 
  group_by(location) %>%
  summarise(
    proportion_DNF = 1 - mean(finished),
    count = n()
  ) %>%
  filter(count > 24) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = location
  )) +
  geom_col() +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    y = "Track Location",
    x = "Observed Probability of DNFs"
  )

```
---
# Exploring the effect of Teams
--
```{r team graph 1, echo=FALSE}
raceresults_cleaned %>%
  group_by(team_group) %>%
  summarise(
    proportion_DNF = 1 - mean(finished),
    count = n()
  ) %>%
  filter(count >= 20) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = team_group
  )) +
  geom_col() +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    x = "Observed Probability of DNF",
    y = "Team"
  )
```
---
# Exploring the effect of Teams
```{r team graph 2, echo=FALSE}
raceresults_cleaned %>%
  group_by(team_group) %>%
  summarise(
    proportion_DNF = 1 - mean(finished),
    count = n()
  ) %>%
  filter(count >= 20) %>%
  ggplot(mapping = aes(
    x = proportion_DNF,
    y = team_group,
    fill = team_group
  )) +
  scale_fill_manual(values = c(
    "Trulli" = "#2ab6ed"
  )) +
  geom_col() +
  theme_minimal() +
  theme(legend.position = "none") +
  labs(
    x = "Observed Probability of DNF",
    y = "Team"
  )
```
---
# Model Selection 
 1)	Choosing the variable to predict and the predictors


--
2)	Choosing the type of model and engine

 

---
# Model Implementation

## Splitting the data & creating the recipe
--
```{r, echo=TRUE}
set.seed(28)
raceresults_split <- initial_split(raceresults_factored)
raceresults_train <- training(raceresults_split)
raceresults_test <- testing(raceresults_split)

raceresults_rec <- recipe(finished_fct ~ driver + team_group + location, data = raceresults_train) %>%
  step_dummy(all_nominal(), -all_outcomes())

```

```{r, echo=FALSE}
raceresults_mod <- logistic_reg() %>%
  set_engine("glm")
```

- Set random seed to make results reproducible
- We used the predictors team group and location to test for finishing outcome (whether they finished the race or not)

---

# Model Implementation (Workflow)
--
```{r, echo=TRUE}
raceresults_wflow <- workflow() %>%
  add_recipe(raceresults_rec) %>%
  add_model(raceresults_mod)
```

- Created workflow to effectively combine steps in order to train data easily

---
# Model Implementation (Training the data)
--
```{r, echo=TRUE}
raceresults_fit <- raceresults_wflow %>%
  fit(data = raceresults_train)
tidy(raceresults_fit)

raceresults_pred <- predict(raceresults_fit, raceresults_test, type = "prob") %>%
  bind_cols(raceresults_test)
raceresults_pred
```

-Used the training data to allow model to learn what the most influential predictors are
-Creates a reliable model which is now trained to make predictions based on the variables it's fed

---
# Model Interpretation

1. We used estimation coefficient and p-values to interpret the multiple predictors (driver, team group and location)
--

2. This tools shows whether the predictors have a significant effect on the race result or not.


---

# Evaluating our model - 3 variables
``` {r model with 3, include = FALSE}
set.seed(28)
raceresults_split <- initial_split(raceresults_factored)
raceresults_train <- training(raceresults_split)
raceresults_test <- testing(raceresults_split)


raceresults_rec <- recipe(finished_fct ~ driver + team_group + location, data = raceresults_train) %>%
  step_dummy(all_nominal(), -all_outcomes())

raceresults_mod <- logistic_reg() %>%
  set_engine("glm")

raceresults_wflow <- workflow() %>%
  add_recipe(raceresults_rec) %>%
  add_model(raceresults_mod)

raceresults_fit <- raceresults_wflow %>%
  fit(data = raceresults_train)
tidy(raceresults_fit)

raceresults_pred <- predict(raceresults_fit, raceresults_test, type = "prob") %>%
  bind_cols(raceresults_test)
raceresults_pred
```

```{r roc 3, echo = FALSE}
raceresults_pred %>%
  roc_curve(
    truth = finished_fct,
    .pred_TRUE,
    event_level = "first"
  ) %>%
  autoplot()
```

---

# Evaluating our model - 1 variable
``` {r model with location, include = FALSE}
set.seed(28)
raceresults_split <- initial_split(raceresults_factored)
raceresults_train <- training(raceresults_split)
raceresults_test <- testing(raceresults_split)


raceresults_rec <- recipe(finished_fct ~ location, data = raceresults_train) %>%
  step_dummy(all_nominal(), -all_outcomes())

raceresults_mod <- logistic_reg() %>%
  set_engine("glm")

raceresults_wflow <- workflow() %>%
  add_recipe(raceresults_rec) %>%
  add_model(raceresults_mod)

raceresults_fit <- raceresults_wflow %>%
  fit(data = raceresults_train)
tidy(raceresults_fit)

raceresults_pred <- predict(raceresults_fit, raceresults_test, type = "prob") %>%
  bind_cols(raceresults_test)
raceresults_pred
```

``` {r roc location, echo = FALSE}
raceresults_pred %>%
  roc_curve(
    truth = finished_fct,
    .pred_TRUE,
    event_level = "first"
  ) %>%
  autoplot()
```

--- 
class: inverse, centre, middle
# Thank you
--
# Questions?